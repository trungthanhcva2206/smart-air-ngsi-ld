version: "3.8"

services:
  # MongoDB for Orion-LD and IoT Agent
  mongo-db:
    image: mongo:4.4
    hostname: mongo-db
    container_name: db-mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo-db-data:/data/db
      - mongo-db-config:/data/configdb
    environment:
      - MONGO_INITDB_DATABASE=orion
    command: --nojournal
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
    
  # Eclipse Mosquitto MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2.0
    hostname: mosquitto
    container_name: mqtt-mosquitto
    ports:
      - "1883:1883"  # MQTT
      - "9001:9001"  # WebSocket
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    command: mosquitto -c /mosquitto-no-auth.conf
    healthcheck:
      test: ["CMD", "mosquitto_pub", "-h", "localhost", "-t", "test", "-m", "test"]
      interval: 30s
      timeout: 10s
      retries: 3

  # FIWARE IoT Agent JSON
  iot-agent:
    image: fiware/iotagent-json:latest
    hostname: iot-agent
    container_name: fiware-iot-agent
    depends_on:
      - mongo-db
      - mosquitto
      - orion
    ports:
      - "4041:4041"  # Northbound (provisioning API)
      - "7896:7896"  # Southbound HTTP (device measurements)
    environment:
      - IOTA_CB_HOST=orion
      - IOTA_CB_PORT=1026
      - IOTA_CB_NGSI_VERSION=ld
      - IOTA_NORTH_PORT=4041
      - IOTA_REGISTRY_TYPE=mongodb
      - IOTA_MONGO_HOST=mongo-db
      - IOTA_MONGO_PORT=27017
      - IOTA_MONGO_DB=iotagent
      - IOTA_HTTP_PORT=7896
      - IOTA_PROVIDER_URL=http://iot-agent:4041
      - IOTA_MQTT_HOST=mosquitto
      - IOTA_MQTT_PORT=1883
      - IOTA_MQTT_PROTOCOL=mqtt
      - IOTA_LOG_LEVEL=DEBUG
      - IOTA_TIMESTAMP=true
      - IOTA_AUTOCAST=true
      - IOTA_DEFAULT_RESOURCE=/iot/json
      - IOTA_JSON_LD_CONTEXT=https://raw.githubusercontent.com/smart-data-models/dataModel.Environment/master/context.jsonld
      - IOTA_FALLBACK_TENANT=hanoi
    healthcheck:
      test: curl --fail -s http://localhost:4041/iot/about || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # Orion-LD Context Broker
  orion:
    image: fiware/orion-ld:latest
    hostname: orion
    container_name: fiware-orion
    depends_on:
      - mongo-db
    ports:
      - "1026:1026"
    environment:
      - ORIONLD_MONGO_HOST=mongo-db
      - ORIONLD_MONGO_DB=orion
      - ORIONLD_PORT=1026
      - ORIONLD_MULTI_SERVICE=TRUE
      - ORIONLD_DISABLE_FILE_LOG=TRUE
      - ORIONLD_LOG_LEVEL=INFO
    command: -dbhost mongo-db -logLevel INFO -forwarding
    healthcheck:
      test: curl --fail -s http://localhost:1026/version || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # QuantumLeap Time Series Data API
  quantumleap:
    image: orchestracities/quantumleap:1.0.0
    hostname: quantumleap
    container_name: fiware-quantumleap
    depends_on:
      - timescale-db
      - redis-cache
    ports:
      - "8668:8668"
    environment:
      - QL_DEFAULT_DB=timescale
      - POSTGRES_HOST=timescale-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=quantumleap
      - POSTGRES_DB_USER=quantumleap
      - POSTGRES_DB_PASS=quantumleap
      - POSTGRES_USE_SSL=False
      - USE_GEOCODING=False
      - CACHE_QUERIES=True
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
      - LOGLEVEL=INFO
    healthcheck:
      test: curl --fail -s http://localhost:8668/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # TimescaleDB for Time Series Storage
  timescale-db:
    image: timescale/timescaledb-ha:pg15-latest
    hostname: timescale-db
    container_name: db-timescale
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=quantumleap
      - POSTGRES_PASSWORD=quantumleap
      - POSTGRES_DB=quantumleap
    volumes:
      - timescale-db-data:/var/lib/postgresql/data
      - ./init-postgis.sh:/docker-entrypoint-initdb.d/01-init-postgis.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U quantumleap"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Cache for QuantumLeap
  redis-cache:
    image: redis:7-alpine
    hostname: redis-cache
    container_name: cache-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-cache-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Grafana for Data Visualization
  grafana:
    image: grafana/grafana:10.2.2
    hostname: grafana
    container_name: grafana
    depends_on:
      - timescale-db
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # MySQL Database for Spring Boot Backend
  mysql-db:
    image: mysql:8.0
    hostname: mysql-db
    container_name: db-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=smartair2024
      - MYSQL_DATABASE=smartair_db
      - MYSQL_USER=smartair
      - MYSQL_PASSWORD=smartair2024
    volumes:
      - mysql-db-data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-psmartair2024"]
      interval: 30s
      timeout: 10s
      retries: 3
  # ========================================
  # ETL Pipeline Service
  # ========================================
  etl-pipeline:
    build:
      context: .
      dockerfile: etl/Dockerfile
    image: smart-air-etl:latest
    container_name: smart-air-etl
    depends_on:
      orion:
        condition: service_healthy
      quantumleap:
        condition: service_healthy
      iot-agent:
        condition: service_healthy
    environment:
      # OpenWeather API
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY}
      
      # Orion-LD (Docker internal)
      - ORION_LD_URL=http://orion:1026
      - ORION_LD_TENANT=hanoi
      
      # QuantumLeap (Docker internal)
      - QUANTUMLEAP_EXTERNAL_URL=http://quantumleap:8668
      - QUANTUMLEAP_INTERNAL_URL=http://quantumleap:8668
      - QUANTUMLEAP_ENABLED=${QUANTUMLEAP_ENABLED:-true}
      
      # MQTT (Docker internal)
      - MQTT_BROKER_HOST=mosquitto
      - MQTT_BROKER_PORT=1883
      
      # ETL Config
      - ETL_MODE=${ETL_MODE:-dual}
      - ETL_INTERVAL_MINUTES=${ETL_INTERVAL_MINUTES:-480}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - HANOI_GEOJSON_PATH=etl/Data/ha_noi_with_latlon2.geojson
    volumes:
      - etl-logs:/app/logs
    restart: unless-stopped
    
    # ========================================
  # Route-Finding Service
  # ========================================
  route-finding:
    build:
      context: .
      dockerfile: route-finding/Dockerfile
    image: smart-air-route-finding:latest
    hostname: route-finding
    container_name: smart-air-route-finding
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "5000:5000"
    environment:
      # Flask Configuration
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
      - FLASK_DEBUG=${FLASK_DEBUG:-False}
      
      # Backend Connection
      - BACKEND_URL=http://backend:8081
      - SSE_ENDPOINT=${SSE_ENDPOINT}
      
      # Graph Configuration
      - GRAPH_FILE=hanoi_road_network.graphml
      - GEOJSON_FILE=ha_noi_with_latlon2.geojson
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # Cache
      - CACHE_ENABLED=True
      - CACHE_TTL=3600
    volumes:
      # Mount cache directory to persist graph data
      - route-finding-cache:/app/cache
      # Mount graph file if pre-built
      - ./route-finding/hanoi_road_network.graphml:/app/hanoi_road_network.graphml:ro
      # Mount GeoJSON file
      - ./route-finding/ha_noi_with_latlon2.geojson:/app/ha_noi_with_latlon2.geojson:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped

  # ========================================
  # Spring Boot Backend API
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: smart-air-backend:latest
    hostname: backend
    container_name: smart-air-backend
    depends_on:
      mysql-db:
        condition: service_healthy
      orion:
        condition: service_healthy
      quantumleap:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    ports:
      - "${BACKEND_PORT:-8123}:8123"
    environment:
      # Spring Boot
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8123
      
      # Database
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      
      # FIWARE Orion-LD
      - ORION_LD_URL=${ORION_LD_URL}
      - ORION_LD_TENANT=${ORION_LD_TENANT}
      - ORION_SERVICE_PATH=${ORION_SERVICE_PATH}
      
      # FIWARE QuantumLeap
      - QUANTUMLEAP_EXTERNAL_URL=${QUANTUMLEAP_EXTERNAL_URL}
      - QUANTUMLEAP_FIWARE_SERVICE=${QUANTUMLEAP_FIWARE_SERVICE}
      - QUANTUMLEAP_QUERY_LASTN=${QUANTUMLEAP_QUERY_LASTN}
      - QUANTUMLEAP_QUERY_DELAY_SECONDS=${QUANTUMLEAP_QUERY_DELAY_SECONDS}
      
      # FIWARE IoT Agent
      - IOT_AGENT_URL=${IOT_AGENT_URL}
      - FIWARE_SERVICE=${FIWARE_SERVICE}
      - FIWARE_API_KEY=${FIWARE_API_KEY}
      
      # Redis
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      
      # Email
      - SPRING_MAIL_HOST=${SPRING_MAIL_HOST}
      - SPRING_MAIL_PORT=${SPRING_MAIL_PORT}
      - SPRING_MAIL_USERNAME=${SPRING_MAIL_USERNAME}
      - SPRING_MAIL_PASSWORD=${SPRING_MAIL_PASSWORD}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME}
      
      # Security
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      
      # Frontend URL
      - FRONTEND_PUBLIC_URL=${FRONTEND_PUBLIC_URL}
      
      # WebFlux Timeouts
      - SPRING_WEBFLUX_CLIENT_CONNECT_TIMEOUT=${SPRING_WEBFLUX_CLIENT_CONNECT_TIMEOUT}
      - SPRING_WEBFLUX_CLIENT_READ_TIMEOUT=${SPRING_WEBFLUX_CLIENT_READ_TIMEOUT}
      - SPRING_WEBFLUX_CLIENT_WRITE_TIMEOUT=${SPRING_WEBFLUX_CLIENT_WRITE_TIMEOUT}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL}
      
      # JVM Options
      - JAVA_OPTS=-Xmx1024m -Xms512m -XX:+UseG1GC
    
    volumes:
      - backend-logs:/app/logs

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    
    restart: unless-stopped
  
  # ========================================
  # Blynk & Telegram Notification Service
  # ========================================
  blynk-notification:
    build:
      context: .
      dockerfile: ./BlynkNotification/Dockerfile
    image: smart-air-blynk:latest
    container_name: smart-air-blynk
    hostname: blynk-notification
    depends_on:
      orion:
        condition: service_healthy
    ports:
      - "${WEBHOOK_PORT:-4999}:4999"
    environment:
      # Flask
      - FLASK_APP=services/notification_service.py
      - FLASK_ENV=production
      
      # Blynk API
      - BLYNK_TOKEN=${BLYNK_TOKEN}
      - BLYNK_SERVER=${BLYNK_SERVER}
      - BLYNK_API_URL=${BLYNK_API_URL:-https://blynk.cloud/external/api}
      
      # Telegram Bot
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      
      # Webhook
      - WEBHOOK_HOST=${WEBHOOK_HOST:-0.0.0.0}
      - WEBHOOK_PORT=${WEBHOOK_PORT:-4999}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - WEBHOOK_INTERNAL_URL=${WEBHOOK_INTERNAL_URL}
      
      # FIWARE Orion-LD
      - ORION_LD_URL=${ORION_LD_URL}
      - ORION_LD_TENANT=${ORION_LD_TENANT}
      - ORION_SERVICE_PATH=${ORION_SERVICE_PATH}
      
      # Thresholds
      - AIR_QUALITY_THRESHOLD_PM25=${AIR_QUALITY_THRESHOLD_PM25:-35.0}
      - AIR_QUALITY_THRESHOLD_PM10=${AIR_QUALITY_THRESHOLD_PM10:-50.0}
      - TEMPERATURE_THRESHOLD_HIGH=${TEMPERATURE_THRESHOLD_HIGH:-35.0}
      - TEMPERATURE_THRESHOLD_LOW=${TEMPERATURE_THRESHOLD_LOW:-10.0}
      - HUMIDITY_THRESHOLD_HIGH=${HUMIDITY_THRESHOLD_HIGH:-80.0}
      - HUMIDITY_THRESHOLD_LOW=${HUMIDITY_THRESHOLD_LOW:-30.0}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    
    volumes:
      - blynk-logs:/app/logs
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4999/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    restart: unless-stopped
  
  # ========================================
  # üîê Certbot - SSL Certificate Manager
  # ========================================
  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --quiet; sleep 12h & wait $${!}; done;'"
    restart: unless-stopped

  # ========================================
  # üé® Frontend - PH·∫¢I S·ª¨A
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL}
        - VITE_API_ROUTE_URL=${VITE_API_ROUTE_URL}
    image: smart-air-frontend:latest
    hostname: frontend
    container_name: smart-air-frontend
    depends_on:
      backend:
        condition: service_healthy
      route-finding:
        condition: service_healthy
    ports:
      - "8080:80"  
      - "8443:443"   # ‚úÖ HTTP (ƒë·ªÉ Let's Encrypt verify)
    environment:
      - NGINX_HOST=${DOMAIN:-airtrack.pro.vn}
      - NGINX_PORT=80
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certbot/conf:/etc/letsencrypt:ro         # ‚úÖ SSL certificates
      - ./certbot/www:/var/www/certbot:ro          # ‚úÖ ACME challenge
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.docker.compose.project=smart-air"
      - "com.docker.compose.service=frontend"
  

volumes:
  mongo-db-data:
    driver: local
  mongo-db-config:
    driver: local
  timescale-db-data:
    driver: local
  redis-cache-data:
    driver: local
  grafana-data:
    driver: local
  mysql-db-data:
    driver: local
  route-finding-cache:    
    driver: local
  etl-logs:
    driver: local
  backend-logs:
    driver: local
  blynk-logs:
    driver: local
  frontend-logs:  
    driver: local
  certbot-conf:    
    driver: local
  certbot-www:    
    driver: local
  

networks:
  default:
    name: fiware-network
    driver: bridge